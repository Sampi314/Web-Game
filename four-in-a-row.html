<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4 in a Row - Connect Four Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            /* Prevent text selection on mobile */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            /* Prevent zoom on double-tap */
            touch-action: manipulation;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: white;
            /* Additional mobile optimization */
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior: none;
        }

        .game-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 700px;
            width: 100%;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .game-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .player-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.3em;
            font-weight: bold;
        }

        .player-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }

        .red {
            background: linear-gradient(135deg, #ff6b6b, #c92a2a);
        }

        .yellow {
            background: linear-gradient(135deg, #ffd93d, #f9ca24);
        }

        .score-board {
            display: flex;
            gap: 20px;
            font-size: 1.1em;
        }

        .score-item {
            text-align: center;
        }

        .score-value {
            font-size: 1.5em;
            font-weight: bold;
            display: block;
            margin-top: 5px;
        }

        .board {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            border-radius: 15px;
            padding: 20px;
            display: inline-block;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            margin: 0 auto;
            display: block;
            width: fit-content;
        }

        .board-grid {
            display: grid;
            grid-template-columns: repeat(7, 70px);
            grid-template-rows: repeat(6, 70px);
            gap: 10px;
        }

        .cell {
            width: 70px;
            height: 70px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            cursor: pointer;
            position: relative;
            transition: all 0.15s ease-out;
            box-shadow: inset 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .cell:hover {
            background: rgba(255, 255, 255, 0.35);
            transform: scale(1.08);
        }

        .cell.disabled {
            cursor: not-allowed;
            pointer-events: none;
        }

        .disc {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: absolute;
            top: 0;
            left: 0;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        }

        .disc.dropping {
            animation: drop 0.25s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        @keyframes drop {
            0% {
                top: -500px;
                opacity: 0.8;
            }
            100% {
                top: 0;
                opacity: 1;
            }
        }

        .disc.red {
            background: linear-gradient(135deg, #ff6b6b, #c92a2a);
            border: 3px solid #a61e1e;
        }

        .disc.yellow {
            background: linear-gradient(135deg, #ffd93d, #f9ca24);
            border: 3px solid #d4a017;
        }

        .winning-disc {
            animation: winning-glow 0.5s infinite alternate ease-in-out;
        }

        @keyframes winning-glow {
            0% {
                box-shadow: 0 0 10px 5px rgba(255, 255, 255, 0.5);
                transform: scale(1);
            }
            100% {
                box-shadow: 0 0 25px 12px rgba(255, 255, 255, 1);
                transform: scale(1.15);
            }
        }

        .controls {
            margin-top: 20px;
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .settings-toggle {
            background: rgba(255, 255, 255, 0.3);
            color: white;
            border: 2px solid white;
            padding: 12px 25px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 15px;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .settings-toggle:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        button {
            padding: 15px 30px;
            font-size: 1.1em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s ease-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            /* Ensure minimum touch target size */
            min-width: 44px;
            min-height: 44px;
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
        }

        button:active {
            transform: translateY(-1px);
            transition: all 0.1s ease-out;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: modalSlideIn 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px) scale(0.95);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        .modal-content h2 {
            font-size: 2.5em;
            margin-bottom: 20px;
        }

        .modal-content p {
            font-size: 1.3em;
            margin-bottom: 30px;
        }

        .winner-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 20px auto;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
        }

        .column-indicator {
            display: grid;
            grid-template-columns: repeat(7, 70px);
            gap: 10px;
            margin-bottom: 10px;
            padding: 0 20px;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }

        .column-arrow {
            width: 70px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            opacity: 0;
            transition: opacity 0.15s ease-out;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .column-arrow.active {
            opacity: 1;
            animation: bounce 0.5s infinite ease-in-out;
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-12px);
            }
        }

        @media (max-width: 768px) {
            .board-grid {
                grid-template-columns: repeat(7, 50px);
                grid-template-rows: repeat(6, 50px);
                gap: 8px;
            }

            .cell {
                width: 50px;
                height: 50px;
            }

            .column-indicator {
                grid-template-columns: repeat(7, 50px);
                gap: 8px;
            }

            .column-arrow {
                width: 50px;
                font-size: 1.5em;
            }

            h1 {
                font-size: 2em;
            }

            .game-info {
                flex-direction: column;
                text-align: center;
            }
        }

        .stats-panel {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            text-align: center;
        }

        .stats-panel h3 {
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
        }

        /* Sound controls */
        .sound-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 10px;
        }

        .sound-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 1.3em;
            transition: all 0.2s ease-out;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 50px;
        }

        .sound-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .sound-toggle:active {
            transform: scale(0.95);
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .volume-slider {
            width: 80px;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.3);
            outline: none;
            cursor: pointer;
            -webkit-appearance: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .volume-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .volume-label {
            font-size: 0.85em;
            opacity: 0.9;
            min-width: 30px;
        }

        @media (max-width: 768px) {
            .sound-controls {
                flex-direction: column;
                padding: 10px;
            }

            .volume-slider {
                width: 120px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>üéÆ 4 in a Row üéÆ</h1>

        <div class="game-info">
            <div class="player-indicator">
                <div class="player-circle" id="currentPlayerCircle"></div>
                <span id="currentPlayerText">Red's Turn</span>
            </div>

            <div class="score-board">
                <div class="score-item">
                    <div>üî¥ Red</div>
                    <span class="score-value" id="redScore">0</span>
                </div>
                <div class="score-item">
                    <div>üü° Yellow</div>
                    <span class="score-value" id="yellowScore">0</span>
                </div>
                <div class="score-item">
                    <div>ü§ù Draws</div>
                    <span class="score-value" id="drawScore">0</span>
                </div>
            </div>

            <div class="sound-controls">
                <button class="sound-toggle" id="soundToggle" onclick="toggleSound()" title="Toggle sound">
                    <span id="soundIcon">üîä</span>
                </button>
                <div class="volume-control">
                    <span class="volume-label" id="volumeLabel">70%</span>
                    <input type="range" class="volume-slider" id="volumeSlider"
                           min="0" max="100" value="70"
                           oninput="updateVolume(this.value)">
                </div>
            </div>
        </div>

        <div class="column-indicator" id="columnIndicator"></div>

        <div class="board">
            <div class="board-grid" id="board"></div>
        </div>

        <div class="controls">
            <button class="settings-toggle" onclick="toggleStats()">üìä Statistics</button>
            <a href="leaderboard.html" style="display: inline-block;">
                <button class="settings-toggle" style="margin-bottom: 0;">üèÜ Global Leaderboard</button>
            </a>
        </div>

        <div class="controls" style="margin-top: 15px;">
            <button onclick="resetGame()">üîÑ New Game</button>
            <button onclick="resetScores()">üìä Reset Scores</button>
        </div>

        <div class="stats-panel" id="statsPanel" style="display: none;">
            <h3>üìä Game Statistics</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-label">Total Games</div>
                    <div class="stat-value" id="totalGames">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Red Win Rate</div>
                    <div class="stat-value" id="redWinRate">0%</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Yellow Win Rate</div>
                    <div class="stat-value" id="yellowWinRate">0%</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Longest Streak</div>
                    <div class="stat-value" id="longestStreak">0</div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="winModal">
        <div class="modal-content">
            <h2 id="winMessage">üéâ Winner! üéâ</h2>
            <div class="winner-circle" id="winnerCircle"></div>
            <p id="winDetails"></p>
            <div id="nameInputSection" style="margin: 20px 0; display: none;">
                <p style="margin-bottom: 10px;">üéâ Enter winner's name for the leaderboard:</p>
                <input type="text" id="playerNameInput" maxlength="20" placeholder="Winner's name"
                    style="padding: 10px; font-size: 1em; border-radius: 5px; border: none; width: 80%; margin-bottom: 15px;">
            </div>
            <button onclick="closeModal()">Play Again</button>
        </div>
    </div>

    <script>
        // Game state
        const ROWS = 6;
        const COLS = 7;
        const PLAYERS = {
            RED: 'red',
            YELLOW: 'yellow'
        };

        let board = [];
        let currentPlayer = PLAYERS.RED;
        let gameActive = true;
        let isAnimating = false; // Prevent rapid clicks during animation
        let debugMode = false; // Toggle with Ctrl+D
        let scores = {
            red: 0,
            yellow: 0,
            draws: 0
        };
        let stats = {
            totalGames: 0,
            redWins: 0,
            yellowWins: 0,
            currentStreak: 0,
            longestStreak: 0,
            streakPlayer: null
        };

        // Sound system
        let audioContext = null;
        let soundEnabled = true;
        let masterVolume = 0.7;

        // Initialize audio context (must be done after user interaction for mobile compatibility)
        function initAudioContext() {
            if (!audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    debug('Audio context initialized');
                } catch (e) {
                    console.error('Web Audio API not supported:', e);
                    soundEnabled = false;
                }
            }
            // Resume context if suspended (for mobile browsers)
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }

        // Play a tone using oscillator
        function playTone(frequency, duration, type = 'sine', volumeMultiplier = 1) {
            if (!soundEnabled || !audioContext) return;

            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.type = type;
                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);

                // Apply envelope for smoother sound
                const now = audioContext.currentTime;
                const volume = masterVolume * volumeMultiplier;

                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(volume, now + 0.01); // Quick attack
                gainNode.gain.linearRampToValueAtTime(volume * 0.7, now + duration * 0.3);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + duration); // Smooth decay

                oscillator.start(now);
                oscillator.stop(now + duration);
            } catch (e) {
                console.error('Error playing tone:', e);
            }
        }

        // Play chord (multiple frequencies)
        function playChord(frequencies, duration, type = 'sine', volumeMultiplier = 1) {
            if (!soundEnabled || !audioContext) return;

            frequencies.forEach((freq, index) => {
                setTimeout(() => {
                    playTone(freq, duration, type, volumeMultiplier / frequencies.length);
                }, index * 10); // Slight delay for richness
            });
        }

        // Sound effects
        const sounds = {
            // Coin drop sound - metallic bounce
            drop: function() {
                initAudioContext();
                if (!soundEnabled) return;

                // Metallic coin drop with bounce effect
                playTone(1200, 0.05, 'square', 0.4); // Initial metallic clink
                setTimeout(() => playTone(800, 0.08, 'triangle', 0.5), 30); // First bounce
                setTimeout(() => playTone(600, 0.06, 'triangle', 0.4), 80); // Second bounce
                setTimeout(() => playTone(500, 0.05, 'triangle', 0.3), 120); // Third bounce
                setTimeout(() => playTone(450, 0.04, 'sine', 0.2), 150); // Final settle
            },

            // Click/hover sound - subtle tick
            click: function() {
                initAudioContext();
                if (!soundEnabled) return;

                playTone(800, 0.05, 'sine', 0.3);
            },

            // Win sound - celebratory fanfare
            win: function() {
                initAudioContext();
                if (!soundEnabled) return;

                // Triumphant fanfare with coins
                const melody = [
                    { freq: 523.25, duration: 0.15, delay: 0 },    // C
                    { freq: 659.25, duration: 0.15, delay: 150 },  // E
                    { freq: 783.99, duration: 0.15, delay: 300 },  // G
                    { freq: 1046.50, duration: 0.4, delay: 450 }   // High C (sustained)
                ];

                // Play melody
                melody.forEach(note => {
                    setTimeout(() => {
                        playTone(note.freq, note.duration, 'sine', 0.7);
                    }, note.delay);
                });

                // Add coin sparkle effects
                for (let i = 0; i < 5; i++) {
                    setTimeout(() => {
                        playTone(1200 + (i * 200), 0.1, 'triangle', 0.3);
                    }, 500 + (i * 100));
                }
            },

            // Draw sound - neutral, balanced tone
            draw: function() {
                initAudioContext();
                if (!soundEnabled) return;

                // Neutral descending-ascending pattern
                playTone(440, 0.15, 'sine', 0.5); // A
                setTimeout(() => playTone(392, 0.15, 'sine', 0.5), 120); // G
                setTimeout(() => playTone(440, 0.25, 'sine', 0.5), 240); // A
            }
        };

        // Toggle sound on/off
        function toggleSound() {
            soundEnabled = !soundEnabled;
            const icon = document.getElementById('soundIcon');
            icon.textContent = soundEnabled ? 'üîä' : 'üîá';

            // Save preference
            localStorage.setItem('fourInARowSoundEnabled', soundEnabled);

            // Play feedback sound when enabling
            if (soundEnabled) {
                sounds.click();
            }

            debug(`Sound ${soundEnabled ? 'enabled' : 'disabled'}`);
        }

        // Update volume
        function updateVolume(value) {
            masterVolume = value / 100;
            document.getElementById('volumeLabel').textContent = value + '%';

            // Save preference
            localStorage.setItem('fourInARowVolume', value);

            // Play feedback sound
            if (soundEnabled) {
                playTone(600, 0.08, 'sine', 0.4);
            }

            debug(`Volume set to ${value}%`);
        }

        // Load sound preferences
        function loadSoundPreferences() {
            try {
                const savedSoundEnabled = localStorage.getItem('fourInARowSoundEnabled');
                const savedVolume = localStorage.getItem('fourInARowVolume');

                if (savedSoundEnabled !== null) {
                    soundEnabled = savedSoundEnabled === 'true';
                    const icon = document.getElementById('soundIcon');
                    icon.textContent = soundEnabled ? 'üîä' : 'üîá';
                }

                if (savedVolume !== null) {
                    const volume = parseInt(savedVolume);
                    masterVolume = volume / 100;
                    document.getElementById('volumeSlider').value = volume;
                    document.getElementById('volumeLabel').textContent = volume + '%';
                }

                debug('Sound preferences loaded', { soundEnabled, masterVolume });
            } catch (e) {
                console.error('Error loading sound preferences:', e);
            }
        }

        // Debug logger
        function debug(message, data = null) {
            if (debugMode) {
                const timestamp = new Date().toISOString();
                if (data) {
                    console.log(`[${timestamp}] üéÆ ${message}`, data);
                } else {
                    console.log(`[${timestamp}] üéÆ ${message}`);
                }
            }
        }

        // Initialize game
        function initGame() {
            debug('Initializing game...');

            // Load sound preferences first
            loadSoundPreferences();

            // Load scores from localStorage with error handling
            try {
                const savedScores = localStorage.getItem('fourInARowScores');
                const savedStats = localStorage.getItem('fourInARowStats');

                if (savedScores) {
                    const parsedScores = JSON.parse(savedScores);
                    // Validate scores object
                    if (parsedScores && typeof parsedScores === 'object') {
                        scores = {
                            red: Number(parsedScores.red) || 0,
                            yellow: Number(parsedScores.yellow) || 0,
                            draws: Number(parsedScores.draws) || 0
                        };
                        debug('Loaded scores from localStorage', scores);
                        updateScoreDisplay();
                    }
                }

                if (savedStats) {
                    const parsedStats = JSON.parse(savedStats);
                    // Validate stats object
                    if (parsedStats && typeof parsedStats === 'object') {
                        stats = {
                            totalGames: Number(parsedStats.totalGames) || 0,
                            redWins: Number(parsedStats.redWins) || 0,
                            yellowWins: Number(parsedStats.yellowWins) || 0,
                            currentStreak: Number(parsedStats.currentStreak) || 0,
                            longestStreak: Number(parsedStats.longestStreak) || 0,
                            streakPlayer: parsedStats.streakPlayer || null
                        };
                        debug('Loaded stats from localStorage', stats);
                    }
                }
            } catch (error) {
                console.error('Error loading game data from localStorage:', error);
                debug('Failed to load localStorage, using defaults');
                // Reset to defaults if corrupted
                localStorage.removeItem('fourInARowScores');
                localStorage.removeItem('fourInARowStats');
            }

            createBoard();
            createColumnIndicators();
            updatePlayerIndicator();
            debug('Game initialized successfully');
        }

        // Create the game board
        function createBoard() {
            board = Array(ROWS).fill().map(() => Array(COLS).fill(null));
            const boardElement = document.getElementById('board');
            boardElement.innerHTML = '';

            for (let row = 0; row < ROWS; row++) {
                for (let col = 0; col < COLS; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.col = col;
                    cell.addEventListener('click', () => handleCellClick(col));
                    cell.addEventListener('mouseenter', () => showColumnIndicator(col));
                    cell.addEventListener('mouseleave', () => hideColumnIndicator(col));

                    // Add touch events for mobile
                    cell.addEventListener('touchstart', (e) => {
                        e.preventDefault(); // Prevent mouse events from firing
                        showColumnIndicator(col);
                    }, { passive: false });

                    cell.addEventListener('touchend', (e) => {
                        e.preventDefault();
                        hideColumnIndicator(col);
                        handleCellClick(col);
                    }, { passive: false });

                    // Prevent context menu on long press
                    cell.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                    });

                    boardElement.appendChild(cell);
                }
            }
        }

        // Create column indicators
        function createColumnIndicators() {
            const indicatorContainer = document.getElementById('columnIndicator');
            indicatorContainer.innerHTML = '';

            for (let col = 0; col < COLS; col++) {
                const arrow = document.createElement('div');
                arrow.className = 'column-arrow';
                arrow.id = `arrow-${col}`;
                arrow.textContent = '‚ñº';
                indicatorContainer.appendChild(arrow);
            }
        }

        // Show column indicator
        function showColumnIndicator(col) {
            if (!gameActive) return;
            const arrow = document.getElementById(`arrow-${col}`);
            if (arrow && canDropInColumn(col)) {
                arrow.classList.add('active');
                // Play subtle click sound on hover
                sounds.click();
            }
        }

        // Hide column indicator
        function hideColumnIndicator(col) {
            const arrow = document.getElementById(`arrow-${col}`);
            if (arrow) {
                arrow.classList.remove('active');
            }
        }

        // Check if can drop in column
        function canDropInColumn(col) {
            return board[0][col] === null;
        }

        // Handle cell click
        function handleCellClick(col) {
            // Prevent clicks during animation or when game is inactive
            if (!gameActive || isAnimating) {
                debug('Click blocked - game inactive or animating');
                return;
            }

            const row = getAvailableRow(col);
            if (row === -1) {
                debug(`Column ${col} is full`);
                return; // Column is full
            }

            // Lock input during animation
            isAnimating = true;
            debug(`Player ${currentPlayer} placing disc at row ${row}, col ${col}`);

            // Update board state
            board[row][col] = currentPlayer;

            // Add disc to UI
            const cellIndex = row * COLS + col;
            const cells = document.querySelectorAll('.cell');
            const cell = cells[cellIndex];

            const disc = document.createElement('div');
            disc.className = `disc ${currentPlayer} dropping`;
            cell.appendChild(disc);

            // Play drop sound
            sounds.drop();

            // Remove dropping class after animation completes to prevent conflict with winning-glow
            setTimeout(() => {
                disc.classList.remove('dropping');
                isAnimating = false; // Unlock input after animation
                debug('Animation complete, input unlocked');
            }, 250);

            // Check for winner
            if (checkWinner(row, col)) {
                gameActive = false;
                debug(`${currentPlayer} wins!`);
                setTimeout(() => showWinModal(currentPlayer), 250);
                updateStats(currentPlayer);
                return;
            }

            // Check for draw
            if (isBoardFull()) {
                gameActive = false;
                debug('Game is a draw');
                setTimeout(() => showDrawModal(), 250);
                updateStats('draw');
                return;
            }

            // Switch player
            currentPlayer = currentPlayer === PLAYERS.RED ? PLAYERS.YELLOW : PLAYERS.RED;
            updatePlayerIndicator();
            debug(`Switched to player: ${currentPlayer}`);
        }

        // Get available row in column
        function getAvailableRow(col) {
            for (let row = ROWS - 1; row >= 0; row--) {
                if (board[row][col] === null) {
                    return row;
                }
            }
            return -1;
        }

        // Check if board is full
        function isBoardFull() {
            return board[0].every(cell => cell !== null);
        }

        // Check for winner
        function checkWinner(row, col) {
            const directions = [
                [[0, 1], [0, -1]],   // Horizontal
                [[1, 0], [-1, 0]],   // Vertical
                [[1, 1], [-1, -1]],  // Diagonal /
                [[1, -1], [-1, 1]]   // Diagonal \
            ];

            for (let direction of directions) {
                const count = 1 + countDirection(row, col, direction[0]) + countDirection(row, col, direction[1]);
                if (count >= 4) {
                    highlightWinningCells(row, col, direction);
                    return true;
                }
            }
            return false;
        }

        // Count consecutive pieces in a direction
        function countDirection(row, col, [dRow, dCol]) {
            let count = 0;
            let r = row + dRow;
            let c = col + dCol;

            while (r >= 0 && r < ROWS && c >= 0 && c < COLS && board[r][c] === currentPlayer) {
                count++;
                r += dRow;
                c += dCol;
            }

            return count;
        }

        // Highlight winning cells
        function highlightWinningCells(row, col, directions) {
            const cells = document.querySelectorAll('.cell');
            const winningCells = [[row, col]];

            for (let [dRow, dCol] of directions) {
                let r = row + dRow;
                let c = col + dCol;

                while (r >= 0 && r < ROWS && c >= 0 && c < COLS && board[r][c] === currentPlayer) {
                    winningCells.push([r, c]);
                    r += dRow;
                    c += dCol;
                }
            }

            winningCells.forEach(([r, c]) => {
                const cellIndex = r * COLS + c;
                const disc = cells[cellIndex].querySelector('.disc');
                if (disc) {
                    disc.classList.add('winning-disc');
                }
            });
        }

        // Update player indicator
        function updatePlayerIndicator() {
            const circle = document.getElementById('currentPlayerCircle');
            const text = document.getElementById('currentPlayerText');

            circle.className = `player-circle ${currentPlayer}`;
            text.textContent = currentPlayer === PLAYERS.RED ? "Red's Turn" : "Yellow's Turn";
        }

        // Show win modal
        function showWinModal(winner) {
            // Validate winner parameter
            if (winner !== PLAYERS.RED && winner !== PLAYERS.YELLOW) {
                console.error('Invalid winner:', winner);
                return;
            }

            debug(`Showing win modal for ${winner}`);

            // Play win sound
            sounds.win();

            scores[winner]++;
            updateScoreDisplay();
            saveScores();

            const modal = document.getElementById('winModal');
            const message = document.getElementById('winMessage');
            const circle = document.getElementById('winnerCircle');
            const details = document.getElementById('winDetails');
            const nameInputSection = document.getElementById('nameInputSection');

            message.textContent = winner === PLAYERS.RED ? 'üéâ Red Wins! üéâ' : 'üéâ Yellow Wins! üéâ';
            circle.className = `winner-circle ${winner}`;
            details.textContent = `${winner === PLAYERS.RED ? 'Red' : 'Yellow'} has won the game!`;

            // Save to leaderboard
            saveToLeaderboard(winner);

            // Show name input if no player name is stored
            const playerName = localStorage.getItem('playerName');
            if (!playerName) {
                nameInputSection.style.display = 'block';
            } else {
                nameInputSection.style.display = 'none';
            }

            modal.classList.add('active');
            updateCellStates(); // Disable cells when game ends
        }

        // Show draw modal
        function showDrawModal() {
            debug('Showing draw modal');

            // Play draw sound
            sounds.draw();

            scores.draws++;
            updateScoreDisplay();
            saveScores();

            const modal = document.getElementById('winModal');
            const message = document.getElementById('winMessage');
            const circle = document.getElementById('winnerCircle');
            const details = document.getElementById('winDetails');

            message.textContent = 'ü§ù Draw! ü§ù';
            circle.style.display = 'none';
            details.textContent = 'The board is full with no winner!';

            modal.classList.add('active');
            updateCellStates(); // Disable cells when game ends
        }

        // Close modal
        function closeModal() {
            // Save name if provided in the input
            const nameInput = document.getElementById('playerNameInput');
            if (nameInput.value.trim()) {
                localStorage.setItem('playerName', nameInput.value.trim());
            }

            const modal = document.getElementById('winModal');
            modal.classList.remove('active');
            nameInput.value = ''; // Clear input for next time
            resetGame();
        }

        // Save to global leaderboard
        function saveToLeaderboard(winner) {
            // Get or prompt for player name
            let playerName = localStorage.getItem('playerName');

            // If name input is visible, get the value from there
            const nameInput = document.getElementById('playerNameInput');
            if (nameInput.value.trim()) {
                playerName = nameInput.value.trim();
                localStorage.setItem('playerName', playerName);
            } else if (!playerName) {
                // If no name stored and input is empty, use default
                playerName = 'Anonymous';
            }

            // Create score entry (each win is worth 1 point)
            const scoreEntry = {
                name: playerName,
                score: 1,
                date: new Date().toISOString()
            };

            // Get existing scores from fourInRowScores (note: without "A")
            let scores = [];
            try {
                const storedScores = localStorage.getItem('fourInRowScores');
                if (storedScores) {
                    scores = JSON.parse(storedScores);
                    if (!Array.isArray(scores)) {
                        scores = [];
                    }
                }
            } catch (e) {
                console.error('Error loading leaderboard scores:', e);
                scores = [];
            }

            // Add new score
            scores.push(scoreEntry);

            // Sort by score (descending), then by date (most recent first)
            scores.sort((a, b) => {
                if (b.score !== a.score) {
                    return b.score - a.score;
                }
                return new Date(b.date) - new Date(a.date);
            });

            // Keep only top 100 scores
            scores = scores.slice(0, 100);

            // Save back to localStorage
            try {
                localStorage.setItem('fourInRowScores', JSON.stringify(scores));
                debug('Score saved to leaderboard', scoreEntry);
            } catch (e) {
                console.error('Error saving leaderboard scores:', e);
            }
        }

        // View leaderboard
        function viewLeaderboard() {
            window.location.href = 'leaderboard.html';
        }

        // Reset game
        function resetGame() {
            debug('Resetting game...');
            gameActive = true;
            isAnimating = false; // Reset animation lock
            currentPlayer = PLAYERS.RED;
            createBoard();
            updatePlayerIndicator();
            updateCellStates(); // Update cell disabled states

            const modal = document.getElementById('winModal');
            modal.classList.remove('active');

            const circle = document.getElementById('winnerCircle');
            circle.style.display = 'block';
            circle.className = 'winner-circle'; // Clear any previous winner class
            debug('Game reset complete');
        }

        // Update score display
        function updateScoreDisplay() {
            document.getElementById('redScore').textContent = scores.red;
            document.getElementById('yellowScore').textContent = scores.yellow;
            document.getElementById('drawScore').textContent = scores.draws;
        }

        // Save scores to localStorage
        function saveScores() {
            try {
                localStorage.setItem('fourInARowScores', JSON.stringify(scores));
                localStorage.setItem('fourInARowStats', JSON.stringify(stats));
                debug('Scores and stats saved to localStorage', { scores, stats });
            } catch (error) {
                console.error('Error saving to localStorage:', error);
                debug('Failed to save to localStorage');
            }
        }

        // Reset scores
        function resetScores() {
            if (confirm('Are you sure you want to reset all scores and statistics?')) {
                scores = { red: 0, yellow: 0, draws: 0 };
                stats = {
                    totalGames: 0,
                    redWins: 0,
                    yellowWins: 0,
                    currentStreak: 0,
                    longestStreak: 0,
                    streakPlayer: null
                };
                updateScoreDisplay();
                updateStatsDisplay();
                saveScores();
            }
        }

        // Update statistics
        function updateStats(result) {
            stats.totalGames++;

            if (result === PLAYERS.RED) {
                stats.redWins++;
                if (stats.streakPlayer === PLAYERS.RED) {
                    stats.currentStreak++;
                } else {
                    stats.currentStreak = 1;
                    stats.streakPlayer = PLAYERS.RED;
                }
            } else if (result === PLAYERS.YELLOW) {
                stats.yellowWins++;
                if (stats.streakPlayer === PLAYERS.YELLOW) {
                    stats.currentStreak++;
                } else {
                    stats.currentStreak = 1;
                    stats.streakPlayer = PLAYERS.YELLOW;
                }
            } else {
                stats.currentStreak = 0;
                stats.streakPlayer = null;
            }

            if (stats.currentStreak > stats.longestStreak) {
                stats.longestStreak = stats.currentStreak;
            }

            updateStatsDisplay();
            saveScores();
        }

        // Toggle statistics panel
        function toggleStats() {
            const panel = document.getElementById('statsPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            if (panel.style.display === 'block') {
                updateStatsDisplay();
            }
        }

        // Update statistics display
        function updateStatsDisplay() {
            // Validate stats values to prevent NaN
            const totalGames = Number(stats.totalGames) || 0;
            const redWins = Number(stats.redWins) || 0;
            const yellowWins = Number(stats.yellowWins) || 0;
            const longestStreak = Number(stats.longestStreak) || 0;

            document.getElementById('totalGames').textContent = totalGames;

            const redWinRate = totalGames > 0 ? ((redWins / totalGames) * 100).toFixed(1) : 0;
            const yellowWinRate = totalGames > 0 ? ((yellowWins / totalGames) * 100).toFixed(1) : 0;

            document.getElementById('redWinRate').textContent = redWinRate + '%';
            document.getElementById('yellowWinRate').textContent = yellowWinRate + '%';
            document.getElementById('longestStreak').textContent = longestStreak;

            debug('Stats display updated', { totalGames, redWinRate, yellowWinRate, longestStreak });
        }

        // Toggle debug mode with Ctrl+D
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'd') {
                e.preventDefault();
                debugMode = !debugMode;
                console.log(`üéÆ Debug mode: ${debugMode ? 'ON' : 'OFF'}`);
                if (debugMode) {
                    console.log('Current game state:', {
                        board,
                        currentPlayer,
                        gameActive,
                        isAnimating,
                        scores,
                        stats
                    });
                }
            }
        });

        // Disable cells when game is inactive
        function updateCellStates() {
            const cells = document.querySelectorAll('.cell');
            cells.forEach(cell => {
                if (!gameActive || isAnimating) {
                    cell.classList.add('disabled');
                } else {
                    cell.classList.remove('disabled');
                }
            });
        }

        // Initialize game on load
        window.addEventListener('load', () => {
            initGame();
            // Welcome message
            console.log('%cüéÆ 4 in a Row - Debug Info', 'color: #667eea; font-size: 16px; font-weight: bold');
            console.log('%cPress Ctrl+D to toggle debug mode', 'color: #888; font-size: 12px');
            console.log('%cBug fixes applied: LocalStorage validation, race condition prevention, input locking', 'color: #4CAF50; font-size: 11px');
        });
    </script>
</body>
</html>
